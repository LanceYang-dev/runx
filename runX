#!/bin/bash

workpath=/usr/share/runX
consolepath=/tmp/runx_consoles
rundir=/run/runX

guestconsole=""
cmd=""
root=""
bundle=""
containerid=""
while (( "$#" ))
do
    if [[ $1 = "--root" ]]
    then
        root=$2
        shift
        shift
        continue
    fi
    if [[ $1 = "--bundle" ]]
    then
        bundle=$2
        shift
        shift
        continue
    fi
    if [[ $1 = "--console-socket" ]]
    then
        guestconsole="$2"
        shift
        shift
        continue
    fi
    if [[ $1 = "--no-pivot" ]]
    then
        shift
        continue
    fi
    if [[ $1 = "--"* ]]
    then
        shift
        shift
        continue
    fi
    if test -z "$cmd"
    then
        cmd=$1
        shift
        continue
    fi
    containerid=$1
    break
done

# create a fake "bundle" to keep a consistent "API"
if test "$bundle"
then
    mkdir -p "$rundir"/"$containerid"
    echo -n "$bundle" > "$rundir"/"$containerid"/bundle
else
    bundle=$( cat "$rundir"/"$containerid"/bundle )
fi

if test $cmd = "state"
then
    $workpath/state $containerid "$bundle"
elif test $cmd = "start"
then
    $workpath/start $containerid
elif test $cmd = "kill"
then
    $workpath/delete $containerid "$bundle"
elif test $cmd = "create"
then
    $workpath/create $containerid "$bundle"

    if  test "$guestconsole"
    then
        mkdir -p $consolepath
        daemonize $workpath/serial_start \
          "$containerid" \
          "$consolepath/$containerid-pty"
        sleep .1
        daemonize $workpath/serial_fd_handler \
          "$guestconsole" \
          "$consolepath/$containerid-pty"
    fi
elif test $cmd = "delete"
then
    if test "$rundir" -a "$containerid"
    then
        rm -rf "$rundir"/"$containerid"
    fi
else
    :
fi
